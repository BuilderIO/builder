---
name: CI

on:
  push:
    branches:
      - vue2-lts

  pull_request:
    branches:
      - vue2-lts

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

jobs:
  sdks-base:
    name: Gen 2 SDKs checks
    runs-on: ubuntu-latest

    steps:
      - name: Setup
        uses: actions/checkout@v3

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'

      - name: ðŸ“¥ Monorepo install
        uses: ./.github/actions/yarn-nm-install
        with:
          cache-node-modules: true
          cache-install-state: true

      - name: Run prettier
        run: yarn workspace @builder.io/sdks ci:lint:sdks

      - name: Typecheck
        run: yarn nx typecheck @builder.io/sdks

      - name: Run tests
        run: yarn nx test @builder.io/sdks

  sdks:
    name: Gen 2 SDKs
    runs-on: ubuntu-latest

    strategy:
      # we still want to run all the SDK tests even if one fails, to get a full picture of the state of the SDKs.
      fail-fast: false
      matrix:
        sdk: ['vue2']
        include:
          - sdk: vue2
            sdk-name: vue

    steps:
      - name: Setup
        uses: actions/checkout@v3

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'

      - name: ðŸ“¥ Monorepo install
        uses: ./.github/actions/yarn-nm-install
        with:
          cache-node-modules: true
          cache-install-state: true

      - name: Build E2E apps
        run: yarn workspace @builder.io/sdks e2e:build:${{ matrix.sdk }}

      - name: Run E2E tests
        run: yarn workspace @builder.io/sdks e2e:run:${{ matrix.sdk }}

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v3
        # Only upload the report if the tests failed
        if: ${{ failure() }}
        with:
          name: ${{ matrix.sdk }}-playwright-report
          path: packages/sdks-tests/playwright-report/
          retention-days: 30
