import { expect } from '@playwright/test';
import { test } from '../helpers/index.js';

test.describe('XSS Exploit', () => {
  test('attempts XSS exploit through postMessage', async ({ page, context }) => {
    // Create a promise that will resolve when a new page is created
    const newPagePromise = context.waitForEvent('page');

    const postedMsgPromise = page.waitForEvent('console', msg =>
      msg.text().includes('posted message')
    );

    // Navigate to the exploit page and get the current URL
    await page.goto('/xss-exploit');

    // Wait for the new page to open
    const newPage = await newPagePromise;
    await newPage.waitForLoadState();

    // Listen for dialog events (alerts) on the new page
    let dialogShown = false;
    newPage.on('dialog', () => {
      dialogShown = true;
    });

    // Wait for the exploit attempt to complete
    await postedMsgPromise;

    // Wait another 2s after the message is posted to ensure the alert doesn't show.
    await newPage.waitForTimeout(2000);

    // Verify no alert was shown
    expect(dialogShown).toBe(false);

    // Clean up by closing the new page
    await newPage.close();
  });
});
